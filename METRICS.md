# Code Health Monitor - 监控指标体系

> 项目管理视角的代码质量和团队效能监控方案

## 📊 监控架构

```
┌─────────────────────────────────────────────────────────────┐
│                    数据采集层 (Git)                          │
│  • 提交历史  • 代码变更  • 文件变动  • 作者信息              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    指标计算层                                │
│  • LOC统计  • 震荡率  • 复杂度  • 风险评分                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────┬──────────────────┬──────────────────────┐
│   日报 (Daily)   │   周报 (Weekly)  │   月报 (Monthly)     │
│  • 当日提交      │  • 提交排行      │  • 趋势分析          │
│  • 风险预警      │  • 高危文件      │  • 健康评分          │
│  • 快速概览      │  • 团队效能      │  • 改进建议          │
└──────────────────┴──────────────────┴──────────────────────┘
```

---

## 📅 日报指标体系

### 一、基础数据（Daily Metrics）

#### 1. 提交统计
- **提交次数** (Commit Count): 当日所有仓库的提交总数
- **活跃开发者** (Active Contributors): 当日有提交的人数
- **涉及仓库** (Active Repositories): 当日被修改的仓库数量

#### 2. 代码变更量
- **新增行数** (Lines Added): 当日新增代码行数
- **删除行数** (Lines Deleted): 当日删除代码行数
- **净增行数** (Net Lines): 新增 - 删除
- **变更文件数** (Files Changed): 当日修改的文件数量

#### 3. 提交质量
- **平均提交大小** (Avg Commit Size): 平均每次提交的行数变更
- **大提交警告** (Large Commits): 单次提交超过500行的次数
- **微小提交** (Tiny Commits): 单次提交少于10行的次数
- **提交信息质量** (Message Quality): 有意义的提交信息占比

---

### 二、风险预警（Risk Alerts）

#### 1. 代码震荡检测（Code Churn）
**定义**: 同一文件在短时间内反复修改，可能表示设计不稳定或bug修复

**检测规则**:
```
震荡文件 = 最近3天内被修改 >= 5次的文件
震荡率 = (震荡文件数 / 总修改文件数) × 100%
```

**风险等级**:
- 🟢 低风险: 震荡率 < 10%
- 🟡 中风险: 10% <= 震荡率 < 30%
- 🔴 高风险: 震荡率 >= 30%

**报告内容**:
- 震荡文件列表（文件路径、修改次数、涉及开发者）
- 可能原因分析（频繁bug修复、需求变更、代码不稳定）

#### 2. 返工率检测（Rework Rate）
**定义**: 新增代码在短时间内被删除，表示无效工作

**检测规则**:
```
返工代码 = 最近7天内新增但在3天内被删除的代码行数
返工率 = (返工代码行数 / 总新增行数) × 100%
```

**风险等级**:
- 🟢 低风险: 返工率 < 15%
- 🟡 中风险: 15% <= 返工率 < 30%
- 🔴 高风险: 返工率 >= 30%

#### 3. 危险文件监控（High-Risk Files）
**检测维度**:

a) **高频修改文件** (Hotspot Files)
   - 定义: 最近7天修改次数 >= 10次的文件
   - 风险: 可能是架构缺陷或bug集中地

b) **大型文件** (Large Files)
   - 定义: 行数 > 1000行的文件
   - 风险: 可维护性差，容易产生bug

c) **复杂文件** (Complex Files)
   - 定义:
     - Java: 类中方法数 > 20
     - Python: 函数数 > 15
     - Vue/JS: 组件行数 > 500
   - 风险: 违反单一职责原则

d) **孤立文件** (Orphan Files)
   - 定义: 最近90天无人修改的文件
   - 风险: 可能是死代码或技术债务

e) **多人冲突文件** (Conflict-Prone Files)
   - 定义: 最近7天有3人以上修改的文件
   - 风险: 容易产生merge冲突

**日报输出**:
```
🚨 危险文件TOP 10:
1. src/main/java/com/example/backend/kb/service/impl/KbFileServiceImpl.java
   - 修改次数: 15次 (7天内)
   - 文件大小: 1256行
   - 涉及开发者: 张三, 李四, 王五
   - 风险标签: [高频修改] [大型文件] [多人协作]
   - 建议: 考虑拆分service，提取公共逻辑
```

#### 4. 工作时间异常（Working Hours Alert）
**检测规则**:
- 深夜提交 (22:00 - 06:00): 可能表示压力过大或进度紧张
- 周末提交: 工作生活平衡问题

**日报输出**:
```
⏰ 工作时间异常:
- 深夜提交: 3次 (张三 2次, 李四 1次)
- 周末工作: 5次提交
- 建议: 关注团队工作压力，评估排期合理性
```

---

### 三、快速健康检查（Quick Health Check）

#### 1. 当日健康评分（Daily Health Score）
**计算公式**:
```
健康分 = 100分 - 扣分项

扣分项:
- 大提交 (>500行): 每次扣5分
- 高震荡率 (>30%): 扣20分
- 高返工率 (>30%): 扣15分
- 提交信息质量差 (<60%): 扣10分
- 深夜/周末工作: 每次扣2分
- 危险文件未处理: 每个扣3分

最低分: 0分
```

**等级划分**:
- 🟢 优秀 (80-100): 代码质量高，团队健康
- 🟡 良好 (60-79): 有改进空间
- 🟠 警告 (40-59): 存在明显问题
- 🔴 危险 (0-39): 需要立即干预

#### 2. 趋势指标（Trend Indicators）
- 📈 健康分趋势: 对比最近7天平均分
- 📉 震荡率趋势: 对比昨日
- 📊 提交频率趋势: 对比上周同期

---

## 📆 周报指标体系

### 一、生产力统计（Productivity Metrics）

#### 1. 提交量排行榜（Commit Leaderboard）
```
排名 | 开发者    | 提交次数 | 新增行数 | 删除行数 | 净增行数 | 文件数 | 平均提交大小
-----|----------|---------|---------|---------|---------|--------|-------------
1    | 张三      | 48      | 12,450  | 3,200   | 9,250   | 235    | 260行/次
2    | 王五      | 15      | 4,800   | 1,200   | 3,600   | 89     | 320行/次
3    | 李四      | 12      | 3,600   | 800     | 2,800   | 67     | 300行/次
```

#### 2. LOC统计（Lines of Code Statistics）

**A. 个人LOC详细统计**
```
开发者: 张三
  - 新增代码: 12,450行
  - 删除代码: 3,200行
  - 净贡献: 9,250行
  - 有效代码率: 74.3% (净增/新增)
  - 主要语言: Java (85%), XML (10%), YAML (5%)
  - 主要模块:
    - backend/kb: 5,600行 (60%)
    - backend/chat: 2,100行 (23%)
    - backend/sharespace: 1,550行 (17%)
```

**B. 团队LOC汇总**
```
本周团队总产出:
  - 新增: 28,500行
  - 删除: 7,800行
  - 净增: 20,700行
  - 平均有效率: 72.6%
```

**C. 仓库LOC分布**
```
仓库                          | 新增    | 删除   | 净增    | 占比
------------------------------|---------|--------|---------|------
backend                       | 15,200  | 4,200  | 11,000  | 53%
file-server                   | 8,900   | 2,100  | 6,800   | 33%
ai-service                    | 3,200   | 1,100  | 2,100   | 10%
data-pipeline                 | 1,200   | 400    | 800     | 4%
```

**D. 代码质量指标**
```
- 平均每人日产出: 414行净增/天
- 代码稳定性: 72.6% (1 - 删除/新增)
- 提交原子性: 68% (提交信息明确且单一职责)
```

---

### 二、高危文件深度分析（High-Risk Files Deep Dive）

#### 1. 高危文件排名（Top 20 Risk Files）
**风险评分模型**:
```python
风险分 = (
    修改频率分 * 0.3 +      # 最近7天修改次数 / 10
    文件大小分 * 0.25 +     # 文件行数 / 1000
    复杂度分 * 0.25 +       # 方法/函数数 / 20
    协作冲突分 * 0.2        # 涉及开发者数 / 5
) * 100

风险等级:
- 🔴 严重 (80-100): 需要立即重构
- 🟠 高 (60-79): 本周内处理
- 🟡 中 (40-59): 计划改进
- 🟢 低 (<40): 关注即可
```

**示例输出**:
```
排名 | 文件路径                                        | 风险分 | 修改次数 | 大小 | 开发者 | 建议
-----|-----------------------------------------------|--------|---------|------|--------|------
1    | KbFileServiceImpl.java                        | 92     | 18次    | 1,456| 4人    | 🔴 拆分
2    | ChatController.java                           | 78     | 12次    | 890  | 3人    | 🟠 重构
3    | ShareSpaceServiceImpl.java                    | 65     | 15次    | 1,120| 2人    | 🟠 优化
```

#### 2. 文件生命周期分析
- **新生文件** (本周新增): 可能需要code review
- **热点文件** (修改频繁): 需要架构审查
- **腐化文件** (长期未维护): 可能是技术债务
- **死代码** (90天无修改): 考虑清理

#### 3. 依赖关系分析
- **高耦合文件**: 被多个文件import的核心类
- **孤立文件**: 无依赖的独立模块
- **循环依赖**: 可能导致编译或运行时问题

---

### 三、团队健康度分析（Team Health Analysis）

#### 1. 工作模式分析（Working Patterns）

**A. 时间分布热力图**
```
时段分布 (本周):
00-06: ██░░░░░░░░ 2%  (深夜)
06-09: ████░░░░░░ 8%  (早晨)
09-12: ████████████ 35% (上午)
12-14: ████░░░░░░ 12% (午休)
14-18: ████████████ 38% (下午)
18-22: ████░░░░░░ 15% (加班)
22-24: ██░░░░░░░░ 3%  (深夜)

工作日 vs 周末:
- 工作日提交: 85次 (89%)
- 周末提交: 10次 (11%)

健康评估: 🟡 中等
- 建议: 深夜提交占比偏高(5%), 关注团队压力
```

**B. 提交节奏分析**
```
提交频率分布:
- 稳定提交 (每天2-5次): 张三, 王五
- 集中提交 (偶尔大批量): 李四, 赵六
- 零星提交 (不规律): 孙七

建议:
- 张三: 提交节奏良好，保持
- 李四: 建议更频繁地提交，减少单次提交量
```

**C. 协作热力图**
```
协作关系 (共同修改文件数):
          张三    王五    李四    赵六
张三       -      12      8       3
王五      12       -      5       2
李四       8       5      -       6
赵六       3       2      6       -

分析:
- 张三 & 王五: 高度协作 (可能需要沟通机制)
- 李四 & 赵六: 中度协作
- 建议: 定期同步，避免代码冲突
```

#### 2. 技能地图（Skill Map）

**按技术栈分类贡献**:
```
开发者    | Java | Python | Vue/JS | 配置文件 | 主要方向
----------|------|--------|--------|----------|----------
张三      | 85%  | 2%     | 5%     | 8%       | 后端架构
王五      | 90%  | 0%     | 3%     | 7%       | 文件服务
李四      | 75%  | 15%    | 5%     | 5%       | 全栈
赵六      | 5%   | 90%    | 0%     | 5%       | AI/Python
孙七      | 10%  | 85%    | 0%     | 5%       | AI/Python

分析:
- 前端能力: 需要补充 (Vue/JS占比低)
- Python团队: 赵六, 孙七 (AI服务)
- 知识孤岛风险: 前端开发依赖少数人
```

#### 3. 代码审查指标（Code Review Metrics）

**注意**: 当前项目无PR流程，建议增加

**模拟指标** (如果有CR流程):
- CR覆盖率: 被review的提交占比
- CR滞留时间: PR创建到合并的时间
- CR评论质量: 有效评论数
- CR响应速度: 首次review时间

**建议**:
```
当前状态: ❌ 无代码审查流程
风险: 代码质量无保障，知识无法传播

改进建议:
1. 引入PR/MR流程 (至少dev → master需要review)
2. 设置review规则: 至少1人approve
3. 建立CR checklist: 代码规范、测试覆盖、安全检查
4. 每周CR统计: 激励参与review
```

---

### 四、代码质量趋势（Quality Trends）

#### 1. 震荡率趋势（Churn Trend）
```
本周震荡率: 18%
对比上周: +5% ↑

震荡文件TOP 5:
1. KbFileServiceImpl.java: 8次修改 (需求变更)
2. ChatController.java: 6次修改 (bug修复)
3. config.py: 7次修改 (配置调整)

分析:
- 震荡率上升: 可能处于功能快速迭代期
- 建议: 稳定核心接口，减少反复修改
```

#### 2. 返工率趋势（Rework Trend）
```
本周返工率: 22%
对比上周: +3% ↑

返工场景分析:
- 功能删除: 35% (需求变更)
- Bug修复: 40% (测试不充分)
- 重构: 25% (设计调整)

建议:
1. 加强需求评审，减少变更
2. 提高测试覆盖率，减少bug
3. 设计阶段投入更多时间
```

#### 3. 技术债务趋势（Tech Debt Trend）
```
技术债务指标:
- TODO/FIXME数量: 47个 (+8 vs上周)
- 未处理高危文件: 12个 (持平)
- 代码重复率: 估计15% (需工具扫描)
- 测试覆盖率: 估计35% (需集成工具)

趋势: ⚠️ 债务累积中
建议: 每周预留20%时间处理技术债务
```

---

### 五、改进建议（Improvement Recommendations）

#### 1. 即时行动项（Immediate Actions）
```
🔴 高优先级:
1. 重构高危文件TOP 3 (本周完成)
   - KbFileServiceImpl.java: 拆分为多个service
   - ChatController.java: 提取公共逻辑

2. 建立Code Review流程 (本周启动)
   - 至少dev → master需要review
   - 设置review checklist

3. 规范提交信息 (立即执行)
   - 使用统一格式: feat/fix/refactor/docs/test
   - 要求说明"为什么"而非"做了什么"
```

#### 2. 短期改进项（This Month）
```
🟠 中优先级:
1. 建立自动化测试体系
   - 单元测试覆盖率目标: 60%
   - 集成测试覆盖核心流程

2. 引入代码质量工具
   - SonarQube: 代码质量扫描
   - JaCoCo: Java代码覆盖率
   - ESLint/Prettier: 前端规范

3. 知识分享机制
   - 每周技术分享: 轮流主讲
   - 文档建设: 核心模块架构文档
```

#### 3. 长期优化项（This Quarter）
```
🟡 低优先级:
1. 架构重构
   - 微服务拆分评估
   - 公共库提取
   - API版本管理

2. 团队能力建设
   - 前端技能培训 (Vue 3最佳实践)
   - 测试驱动开发 (TDD)
   - 代码审查文化

3. 工程效率提升
   - CI/CD流水线优化
   - 开发环境容器化
   - 性能监控体系
```

---

## 🛠️ 实施方案

### 1. 自动化脚本

**目录结构**:
```
.code-health/
├── README.md                    # 本文档
├── scripts/
│   ├── daily-report.sh         # 日报生成脚本
│   ├── weekly-report.sh        # 周报生成脚本
│   ├── analyze-churn.py        # 震荡分析
│   ├── analyze-rework.py       # 返工分析
│   ├── find-hotspots.py        # 高危文件检测
│   ├── team-stats.py           # 团队统计
│   └── utils.py                # 公共工具函数
├── templates/
│   ├── daily-template.md       # 日报模板
│   └── weekly-template.md      # 周报模板
├── reports/
│   ├── daily/                  # 日报存档
│   │   ├── 2025-12-30.md
│   │   └── 2025-12-31.md
│   └── weekly/                 # 周报存档
│       ├── 2025-W52.md
│       └── 2026-W01.md
└── config.yaml                 # 配置文件
```

### 2. 执行计划

**日报**:
- 执行时间: 每天 18:00 自动运行
- 生成时长: < 1分钟
- 发送方式: Email / 飞书 / 钉钉
- 接收人: 项目经理、技术负责人

**周报**:
- 执行时间: 每周五 17:00 自动运行
- 生成时长: < 5分钟
- 发送方式: Email + 周会分享
- 接收人: 全体团队成员

### 3. 配置示例

```yaml
# config.yaml
repositories:
  - path: /path/to/your/backend
    name: your-backend
    type: java
  - path: /path/to/your/file-server
    name: your-file-server
    type: java
  - path: /path/to/your/multiagent-service
    name: your-multiagent-service
    type: python
  - path: /path/to/your/web-h5
    name: your-web-h5
    type: vue

thresholds:
  large_commit: 500        # 大提交阈值（行）
  churn_days: 3           # 震荡检测天数
  churn_count: 5          # 震荡检测次数
  rework_days: 7          # 返工检测天数
  rework_delete_days: 3   # 返工删除天数
  hotspot_days: 7         # 热点文件天数
  hotspot_count: 10       # 热点修改次数
  large_file: 1000        # 大文件行数
  complex_methods: 20     # 复杂方法数（Java）
  complex_functions: 15   # 复杂函数数（Python）

notification:
  email:
    enabled: true
    smtp_server: smtp.example.com
    from: devops@example.com
    to:
      - manager@example.com
      - tech-lead@example.com
  feishu:
    enabled: false
    webhook: https://open.feishu.cn/open-apis/bot/v2/hook/xxx
  dingtalk:
    enabled: false
    webhook: https://oapi.dingtalk.com/robot/send?access_token=xxx

working_hours:
  normal_start: "09:00"
  normal_end: "18:00"
  late_night_start: "22:00"
  late_night_end: "06:00"
```

---

## 📈 可视化建议

### 1. 仪表盘工具选择

**A. 简单方案** (Markdown + GitHub Pages)
- 成本: 免费
- 工具: GitHub Pages + Markdown
- 优点: 简单快速
- 缺点: 交互性差

**B. 中级方案** (Grafana + Prometheus)
- 成本: 低
- 工具: Grafana + Git Exporter
- 优点: 实时监控，图表丰富
- 缺点: 需要部署维护

**C. 高级方案** (自建平台)
- 成本: 高
- 工具: React + ECharts + Node.js
- 优点: 完全定制化
- 缺点: 开发成本高

### 2. 推荐方案

**第一阶段** (当前):
- Markdown日报/周报 + Email通知
- 成本最低，快速启动

**第二阶段** (1个月后):
- Grafana仪表盘 + 定时邮件
- 可视化增强，历史趋势

**第三阶段** (3个月后):
- 集成到项目管理平台 (Jira/Teambition)
- 一站式管理

---

## 🎯 成功指标

### 短期目标（1个月）
- ✅ 日报/周报自动化运行
- ✅ 团队100%知晓健康监控机制
- ✅ 高危文件数量下降30%
- ✅ 提交信息质量提升到80%

### 中期目标（3个月）
- ✅ 建立Code Review流程，覆盖率100%
- ✅ 震荡率控制在15%以内
- ✅ 返工率降低到15%以内
- ✅ 深夜/周末提交降低50%

### 长期目标（6个月）
- ✅ 代码质量评分稳定在85分以上
- ✅ 测试覆盖率达到60%
- ✅ 技术债务不增长
- ✅ 团队满意度提升

---

## 📝 附录

### A. 提交信息规范

**格式**:
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type类型**:
- `feat`: 新功能
- `fix`: bug修复
- `refactor`: 重构
- `docs`: 文档更新
- `test`: 测试相关
- `chore`: 构建/工具链
- `style`: 代码格式（不影响逻辑）
- `perf`: 性能优化

**示例**:
```
feat(kb): 新增知识库文件上传功能

- 支持大文件分片上传
- 增加文件类型校验
- 添加上传进度回调

Closes #123
```

### B. Code Review Checklist

**功能性**:
- [ ] 功能实现符合需求
- [ ] 边界条件处理完善
- [ ] 错误处理合理

**代码质量**:
- [ ] 命名清晰易懂
- [ ] 遵循代码规范
- [ ] 无重复代码
- [ ] 函数/方法职责单一

**安全性**:
- [ ] 无SQL注入风险
- [ ] 无XSS风险
- [ ] 敏感信息加密
- [ ] 权限校验完整

**性能**:
- [ ] 无明显性能问题
- [ ] 数据库查询优化
- [ ] 合理使用缓存

**测试**:
- [ ] 单元测试覆盖
- [ ] 测试用例完整
- [ ] 手工测试通过

---

## 🔄 持续改进

本监控体系将持续迭代：
- 每月回顾指标有效性
- 根据团队反馈调整阈值
- 增加新的分析维度
- 优化报告可读性

**版本**: v1.0
**最后更新**: 2025-12-30
**维护者**: DevOps团队
